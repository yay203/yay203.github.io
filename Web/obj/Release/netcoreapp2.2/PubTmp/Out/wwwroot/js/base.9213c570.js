/*! ©moviesrv 1.0.0 */
$.localStorage = function() { try { return window.localStorage || $.browser.msie && document.documentElement.addBehavior && { _getData: function() { var a, b = document.createElement("input"); return b.type = "hidden", b.style.display = "none", b.addBehavior("#default#userData"), document.body.appendChild(b), a = new Date, a.setDate(a.getDate() + 365), b.expires = a.toUTCString(), this._getData = function() { return b }, b }, name: "userData", _decode: function(a) { return a.replace(/[\/%]/g, "") }, setItem: function(a, b) { a = this._decode(a); var c = this, d = c._getData(); d.load(c.name), d.setAttribute(a, b), d.save(c.name) }, getItem: function(a) { a = this._decode(a); var b = this._getData(); return b.load(this.name), b.getAttribute(a) }, removeItem: function(a) { a = this._decode(a); var b = this, c = b._getData(); c.load(b.name), c.removeAttribute(a), c.save(b.name) } } } catch (a) { return { setItem: $.noop, getItem: $.noop, removeItem: $.noop} } } (), $(function() { var a, b, c, d = window, e = $(d), f = $("body"), g = $.browser.msie && $.browser.version < 7, h = window.encodeURIComponent; $.Cookie = { get: function(a) { var b = document.cookie.match(new RegExp("(?:^| )" + h(a) + "=([^;]+)")); return b && decodeURIComponent(b[1]) }, set: function(a, b, c, d, e, f) { document.cookie = h(a) + "=" + h(b) + "; expires=" + new Date(+new Date + 864e5 * (c || 1)).toGMTString() + "; path=" + (d || "/") + "; domain=" + (e || document.domain.split(".").slice(-2).join(".")) + (f ? "; secure" : "") }, remove: function(a, b, c, d) { this.set(a, "", new Date(0), b, c, d) } }; var i = d.Popup = { showLoading: function() { i.show('<div class="left-marginal"><h2 class="marginal-heading"><img src="/static/movie/img/loading_jump.gif" /></h2><div class="marginal-bd">正在联系导演锁定座位，请稍候</div></div>') }, create: function() { $("#popup")[0] || f.append('<div id="popup"></div>'), $("#mask")[0] || f.append('<div id="mask"></div>'), a = $("#popup"), b = $("#mask"), i.attach(), i.create = function() { } }, attach: function() { f.on("click", ".J_ClosePopup", i.hide), b.click(i.hide), e.resize(i.alignMiddle) }, hide: function() { return a && a.size() && (a.hide(), b.hide()), !1 }, alignMiddle: function() { a.is(":hidden") || (a.css({ left: (e.width() - a.width()) / 2 + "px", top: (e.height() - a.height()) / 2 + "px" }), g && (a.css("top", d.parseInt(a.css("top"), 10) + e.scrollTop() + "px"), b.css("height", f.height() + "px"))) }, show: function(c) { i.create(), a.html(c).show(), b.show(), i.alignMiddle() }, templateShow: function(a, b) { "undefined" == typeof b && (b = a, a = $("#popup-template").html()), b.btn || (b.btn = '<span class="btn btn-normal J_ClosePopup">确定</span>'); var c = a.replace(/{(\w+)}/g, function(a, c) { return b[c] || "" }); i.show(c) }, getButton: function(a) { for (var b = 0, c = a.length, d = []; c > b; ++b) d.push('<a href="', a[b].linkUrl, '" class="btn', b > 0 ? "" : " btn-normal", a[b].linkUrl ? "" : " J_ClosePopup", '">', a[b].prompt, "</a>"); return d.join("") } }, j = d.Tooltip = { create: function() { $("#tooltip")[0] || f.append('<div id="tooltip"><i class="tri"></i><s class="tri"></s><p></p></div>'), c = $("#tooltip"), j.create = function() { } }, show: function(a, b) { d.clearTimeout(j.timer), a = $(a).eq(0); var e = a.offset(); j.create(), c.find("p").html(b), c.show().css({ top: e.top - c.outerHeight() - 5 + "px", left: e.left - c.outerWidth() / 2 + a.outerWidth() / 2 + "px" }) }, hide: function() { c && c.size() && c.hide() } }, k = d.Seat = { data: { seatNum: 0, seats: [], seatTypes: [], seatsNo: [] }, attach: function(a, b, c, e, f) { var g = $("#wanda").val(); "1" != g && ($.getJSON("/xuanzuo/show/" + a + "/seats", function(a) { if (null == a) return i.templateShow({ msg: "座位图加载失败，请刷新重试", btn: '<a href="javascript:window.location.reload();" class="btn">确定</a>' }), !1; if (null != a.error && (i.templateShow({ msg: a.error.errMsg, btn: i.getButton(a.error.buttons) }), null == a.data)) return !1; var b, d, g = a.data, h = 0, j = $("#J_SeatInfo"), l = ""; for (var m in g) h = Math.max(h, g[m].cols); h > 26 ? (b = " seat-overflow", d = ' style="width:' + 24 * h + 'px"') : (b = "", d = ""); for (var m in g) { l += '<div class="seat-item' + b + '" data-sectionid="' + g[m].sectionId + '" data-sectionname="' + g[m].sectionName + '">', 0 == m && (l += "<h2" + d + "><span>银幕</span></h2>"), g.length > 1 && (l += "<h3" + d + ">" + g[m].sectionName + "</h3>"), l += '<div class="seat-content"' + d + ">"; for (var n = g[m].seats, o = n.length, p = 0; o > p; p++) { l += '<p><span class="num">' + n[p].rowId + "</span>"; var q = n[p].columns; for (var r in q) seatClass = "L" == q[r].st || "R" == q[r].st ? "love" : "N" == q[r].st ? "active" : "disabled", l += q[r].columnId ? '<a href="javascript:;" hidefocus="true" class="seat ' + seatClass + '" data-no="' + q[r].seatNo + '" data-type="' + q[r].st + '" data-row="' + n[p].rowId + '" data-column="' + q[r].columnId + '" title="' + n[p].rowId + "排" + q[r].columnId + '座"></a>' : '<span class="seat"></span>'; l += "</p>" } l += "</div></div>" } j.html(l), "" != c && k.insertSeats(c, e, f) }), $("#J_SeatInfo").on("mouseover", ".seat", function() { return j.hide(), !1 }).on("click", ".seat", function() { var a = $(this), c = a.data("type"), d = k.data.seatNum; if (a.hasClass("selected")) return 1 > d ? (i.templateShow({ msg: "未知错误，请刷新重试", btn: '<a href="javascript:window.location.reload();" class="btn">确定</a>' }), !1) : ("L" === c || "R" === c ? (k.cancel(a), k.cancel("L" === c ? a.next() : a.prev())) : "N" === c && k.cancel(a), !1); if ("LK" === c) return j.show(a, "该座位已售出"), !1; if (!/^[LRN]$/.test(c)) return !1; if (!a.hasClass("selected")) return d > b ? (i.templateShow({ msg: "未知错误，请刷新重试", btn: '<a href="javascript:window.location.reload();" class="btn">确定</a>' }), !1) : k.data.sectionId && k.data.sectionId !== a.parents(".seat-item").data("sectionid") ? (j.show(a, "只可以选同一场区座位"), !1) : (d === b ? j.show(a, "一次最多选择4个座位") : "L" === c || "R" === c ? 3 === d ? j.show(a, "此处为情侣座，您需要至少删除一个座位才可以选择") : (k.choose(a), k.choose("L" === c ? a.next() : a.prev())) : "N" === c && k.choose(a), !1) }), $(d.document.forms.chooseForm).submit(function(a) { function b() { var a = $.extend({}, f); a.seats = a.seats.join("|"), a.seatsNo = a.seatsNo.join("|"), a.seatTypes = a.seatTypes.join("|"), $.post(c.attr("action"), a, function(a) { a.status && a.error ? (i.templateShow({ msg: a.error.errMsg, btn: i.getButton(a.error.buttons) }), e.removeAttr("disabled").val("提交订单")) : d.location.href = a.data && a.data.payUrl || "" }, "json").fail(function() { i.hide(), e.removeAttr("disabled").val("提交订单") }) } var c = $(this), e = c.find("input[type=submit]"), f = k.data; if (a.preventDefault(), !e.attr("disabled")) { if (f.seatNum < 1) return i.templateShow({ msg: "请至少选择一个座位。" }), void 0; if (!k.isConform()) return i.templateShow({ msg: k.data.seatNum > 1 ? "请选择相连的座位，旁边不要留下单独空座" : "请重新选择座位，旁边不要留下单个空座" }), void 0; e.attr("disabled", "disabled").val("正在提交..."), k.checkBinding ? k.checkBinding(function(a) { a ? e.removeAttr("disabled").val("提交订单") : b() }) : (i.showLoading(), b()) } })) }, choose: function(a) { a = $(a); var b = a.parents(".seat-item"), c = $("#J_movieInfo"), d = k.data, e = d.seatNum; 0 === e && (d.sectionId = b.data("sectionid"), d.sectionName = b.data("sectionname"), d.showDate = c.data("showdate"), d.showId = c.data("showid"), d.poiId = c.data("poiid")), ++d.seatNum, d.seats.push(a.data("row") + ":" + a.data("column")), d.seatsNo.push(a.data("no")), d.seatTypes.push(a.data("type")), a.addClass("selected"), k.show() }, cancel: function(a) { a = $(a); var b = k.data, c = b.seatNum; 1 === c && (b.sectionId = "", b.sectionName = "", b.showDate = "", b.showId = "", b.poiId = ""), --b.seatNum, k.remove(b.seats, a.data("row") + ":" + a.data("column")), k.remove(b.seatsNo, a.data("no")), k.remove(b.seatTypes, a.data("type")), a.removeClass("selected"), k.show() }, remove: function(a, b) { a.splice($.inArray(b, a), 1) }, show: function() { var a, b = k.data.seats, c = $("#J_SeatShow"); b.length ? c.show() : c.hide(), c.find("li").each(function(a) { b[a] ? $(this).addClass("selected").text(b[a].replace(":", "排") + "座") : $(this).removeClass("selected").text(a + 1) }); var d = c.parents("form").find(".val"), e = b.length; a = this.NxF(e, c.data("price")), d.eq(0).html("&#165;" + a), k.data.originalPrice = a; var f = d.eq(0).next(".fee"); f.size() && f.html("（含服务费&#165;" + this.NxF(e, c.data("fee")) + "）") }, NxF: function(a, b) { var c = ("" + b).split("."), d = c[1] && c[1].length; return d ? a * c.join("") / Math.pow(10, d) : a * b }, isActive: function(a) { return a.size() && a.hasClass("active") && !a.hasClass("selected") }, isSelected: function(a) { return a.size() && a.hasClass("selected") }, isXOX: function(a, b, c) { var d = b(a); if (k.isActive(d)) { if (d = b(d), k.isActive(d)) return !1; if (k.isSelected(d)) return !0; if (!k.isActive(d)) { var e = 4; for (d = a; e--; ) if (d = c(d), !k.isSelected(d)) return k.isActive(d) ? !0 : !1 } } }, isConform: function() { function a(a) { return a.prev() } function b(a) { return a.next() } for (var c, d = $("#J_SeatInfo .selected"), e = 0, f = d.length; f > e; ++e) if (c = d.eq(e), "N" === c.data("type") && (k.isXOX(c, a, b) || k.isXOX(c, b, a))) return !1; return !0 }, insertSeats: function(a, b, c) { b = b.split("|"), c = c.split("|"); for (var d, e, f = $("#J_SeatInfo"), g = f.find(">.seat-item[data-sectionid=" + a + "] a"), h = 0, i = b.length; i > h; ++h) d = b[h].split(":"), e = g.filter("[data-row=" + d[0] + "][data-column=" + d[1] + "]"), e[0].className = "seat active", e[0].setAttribute("data-type", c[h]), k.choose(e.eq(0)) } }; k.bindMobile = function(a) { function b() { var a = g.val(); /^1\d{10}$/.test(a) ? f.removeClass("btn-disabled") : f.addClass("btn-disabled") } function c() { f.addClass("btn-disabled"); var a = 60, c = setInterval(function() { --a < 1 ? (b(), f.text("重新发送"), clearInterval(c)) : f.text(a + "秒后重试") }, 1e3) } function d(a, b) { a = a || "", b ? $("#J_BindMsg").addClass("msg-ok").text(a) : $("#J_BindMsg").removeClass("msg-ok").text(a) } if (a = $(a), a[0]) { var e, f = a.find("button"), g = f.prev(), h = f.next(); g.keyup(b).blur(b), f.click(function() { f.hasClass("btn-disabled") || ($.post(a.data("codeurl"), { mobile: g.val() }, function(a) { a && !a.status ? (d(a.message || "验证码已发送", !0), e = !0) : d(a && a.message || "发送失败，请稍后重试") }, "json"), c()) }), k.checkBinding = function(b) { e && h.val() ? $.post(a.data("bindurl"), { mobile: g.val(), code: h.val(), cityId: a.data("cityid") }, function(c) { c && !c.status ? (k.checkBinding = function(a) { a(null) }, k.checkBinding(b), a.before('<p class="phone"><span class="gray">取票手机</span> ' + g.val() + "</p>").hide()) : (d(c && c.message || "绑定手机号码失败，请稍后重试"), b("bind error")) }, "json").fail(function() { b("send fail") }) : (d(e ? "请输入短信验证码" : "请验证手机号码"), b("empty code")) } } }, k.showTime = function(a) { a = $(a), a.click(function() { return l.toggle(a), _gaq.push(["_trackEvent", "InnerLink", "Click", "shop/changeShow"]), !1 }) }; var l = { _node: $("#show-time-tips"), _url: location.pathname, _now: !1, currItem: -1, attach: function() { this._node.on("click", ".J_Tab", function() { var a = $(this), b = "selected", c = a.data("i"); c != l.currItem && (a.addClass(b), a.siblings("[data-i=" + l.currItem + "]").removeClass(b), l._node.find(".content").eq(c).addClass(b).end().eq(l.currItem).removeClass(b), l.currItem = c) }).click(function(a) { a.stopPropagation() }), f.click(function() { l._node.hide() }) }, toggle: function(a) { this._node.is(":hidden") ? (this._node.show(), this.position(a), this.loadData(a.data("url"))) : this._node.hide() }, position: function(a) { var b = a.offset(), c = a.outerWidth(), d = a.outerHeight(); this._node.css({ left: b.left + c - (this._node.width() || 332) - 2 + "px", top: b.top + d - 1 + "px" }) }, loadData: function(a) { var b = $.localStorage, c = (new Date).getTime(), e = b.getItem(a + "_time"), f = b.getItem(a); !f || e && c - 18e5 > e ? ($.get(a, function(d) { var e = $.parseJSON(d); e.status ? i.templateShow({ msg: d.errMsg || d.error && d.error.errMsg || "未知错误，请刷新页面重试" }) : (l.show(e.data), b.setItem(a, d), b.setItem(a + "_time", c), l.loadData = function() { }) }).fail(function() { i.templateShow({ msg: d.navigator.onLine === !1 ? "请连接您的网络后重试" : "访问繁忙，请稍后重试" }) }), f && b.clear && b.clear()) : (l.show(f), l.loadData = function() { }) }, show: function(a) { "string" == typeof a && (a = $.parseJSON(a).data); var b, c = a.length, d = ["<ul>"], e = [], f = 0, g = ""; if (c) { for (; c > f; ++f) _now = !1, g = this.getShowList(a[f].shows), _now && -1 === l.currItem ? (b = "selected", l.currItem = f) : b = "", d.push('<li class="J_Tab ', b, '" data-i="', f, '">', a[f].date, "</li>"), e.push('<div class="content ', b, '"><p>', g, "</p></div>"); this.attach() } else d.push('<li class="selected">无数据...</li>'), e.push('<div class="content selected"><p>暂无相关地区信息。</p></div>'); d.push("</ul>"), this._node.find(".hd").html(d.join("")).addBack().find(".bd").html(e.join("")), c && -1 === l.currItem && l._node.find(".J_Tab").eq(0).click() }, getShowList: function(a) { for (var b = 0, c = a.length, d = []; c > b; ++b) this._url == a[b].seatUrl ? (nowClass = 'class="now"', _now = !0) : nowClass = "", d.push("<a " + nowClass + 'href="', a[b].seatUrl, '">', a[b].showTime, "</a>"); return d.join("") } }, m = d.Pay = { status: 0, countdown: function(a) { var b, c = $("#J_RemainingTime"), e = c.data("time"); return e > 0 ? (b = d.setInterval(function() { if (0 > e) return d.clearInterval(b), m.status || i.templateShow({ msg: "已超过支付时间，该订单已自动取消", btn: a }), void 0; var f = e > 60 ? "<em>" + d.parseInt(e / 60, 10) + "</em> 分钟 " : "", g = "<em>" + e % 60 + "</em> 秒"; c.html(f + g), --e }, 1e3), void 0) : (i.templateShow({ msg: "您已超过支付时间", btn: a }), void 0) }, showPayTip: function() { $(d.document.forms.payForm).submit(function() { for (var a = $(this).find("[name=coupon]:checked"), b = $(this).find("[name=magicCards]"), c = "", d = 0; d < a.length; d++) d && (c += "|"), c += d + 1 + ":" + $(a[d]).attr("data-code"); if (b.val(c), 0 != $(".pay-amount em").html().replace(/¥/, "")) { if ($(this).find("[name=payType]:checked").size() < 1) return i.templateShow({ msg: "请选择一家银行支付" }), !1 } else $(this).find("[name=payType]:checked").size() < 1 && $("#PayType0").prop("checked", !0); i.show($("#pay-template").html()), m.status = 1 }) }, toggle: function(a) { a = $(a), a.find("h3").click(function(a) { a.preventDefault(), $(this).find("i").toggleClass("selected").addBack().next("ul").toggle() }) }, coupon: function(a, b, c, d, e) { function f(a) { a.prop("checked") ? (c = i(c, Number(a.val())), r++) : (c = h(c, Number(a.val())), r == b && $("input[name='coupon']").each(function() { var a = $(this); "this" == a.attr("data-session") && "disabled" == a.attr("disabled") && (a.attr("disabled", !1), a.next().removeClass("disabled")) }), r--), r == b && $("input[name='coupon']").each(function() { var a = $(this); "this" == a.attr("data-session") && "checked" != a.attr("checked") && (a.attr("disabled", !0), a.next().addClass("disabled")) }), 0 >= r ? k.hide() : k.show(), 0 >= c ? (j.html("&#165;0"), $(l[0]).html(r), $(l[1]).html(s), m.html("&#165;0"), $("#J_PayList").find("i").addClass("selected").addBack().find("ul").hide(), $("input[type='submit']").val("确认购买"), 0 > c && o.html("优惠金额超过所需支付金额 <strong>" + i(0, c) + "</strong> 元，超出部分将不予返还。")) : (j.html("&#165;" + c), $(l[0]).html(r), $(l[1]).html(i(s, c)), m.html("&#165;" + c), $("#J_PayList").find("i").eq(0).removeClass("selected").parent().next().show(), $("input[type='submit']").val("确认无误，去付款"), o.html("")) } function g(a) { return a = new Date(1e3 * a), (a.getFullYear() + "-" + (a.getMonth() + 1) + "-" + a.getDate()).replace(/\b(\w)\b/g, "0$1") } function h(a, b) { var c, d, e; try { c = a.toString().split(".")[1].length } catch (f) { c = 0 } try { d = b.toString().split(".")[1].length } catch (f) { d = 0 } return n = c >= d ? c : d, e = Math.pow(10, n), parseFloat(((a * e + b * e) / e).toFixed(n)) } function i(a, b) { var c, d, e, f; try { c = a.toString().split(".")[1].length } catch (g) { c = 0 } try { d = b.toString().split(".")[1].length } catch (g) { d = 0 } return f = c >= d ? c : d, e = Math.pow(10, f), parseFloat(((a * e - b * e) / e).toFixed(f)) } for (var j = $(".pay-amount em"), k = $("#J_showcoupon"), l = $("#J_showcoupon strong"), m = $("#J_showcoupon em"), o = $(".tips-coupon"), p = $("input[type='checkbox']:checked"), q = !1, r = 0, s = c, t = 0; t < p.length; t++) $(p[t]).prop("checked", !1); $("#J_coupon").on("click", function() { q ? (q = !1, $(this).removeClass("use-coupon-show")) : (q = !0, $(this).addClass("use-coupon-show")), j = $(".pay-amount em"), $(".add-coupon").toggle() }), $("#J_checkcoupon").on("click", "input", function() { var a = $(this); f(a) }), $("#J_addcoupon").on("click", function() { var a = $(this).prev(), c = $("#J_checkcoupon"); if ("" != a.val()) { for (var h = $("#J_checkcoupon input"), i = $("input[name='coupon']:checked"), j = "", k = 0; k < h.length; k++) { var l = $(h[k]); if (l.attr("data-code") == a.val()) return l.prop("checked") || "this" != l.attr("data-session") || (r == b && (i.eq(0).prop("checked", !1), f(i.eq(0))), l.prop("checked", !0), f(l)), $(".coupon-new").remove(), "this" == l.attr("data-session") ? $(".tips-add-coupon").addClass("exist").html("已在上方列表中，并勾选使用") : $(".tips-add-coupon").addClass("exist").html("已在上方列表中，但本地区无法使用"), a.val(""), setTimeout(function() { $(".tips-add-coupon").removeClass("exist").html("") }, 5e3), void 0 } var m = location.href, n = m.substr(0, m.lastIndexOf("/")); $.ajax({ type: "POST", url: n + "/magiccard", dataType: "json", data: { code: a.val() }, success: function(h) { if (h && h.magiccard) { var k = h.magiccard, l = "", m = "", n = ""; d++, j = '<li><input id="coupon' + (d - 1) + '" type="checkbox" name="coupon" value="', k.canUse ? l = "this" : (l = "that", m = 'disabled="disabled"', n = 'class="disabled"'), j += 1 === k.type ? k.value + '" data-session="' + l + '" data-code="' + k.code + '"' + m + '/> <label for="' + (d - 1) + '"' + n + 'title="' + k.limitDesc + '">第' + d + "张 " + k.value + "元代金券 [" + g(k.endTime) + '到期]</label><span class="coupon-new"></span></li>' : e + '" data-session="' + l + '" data-code="' + k.code + '"' + m + '/> <label for="coupon' + (d - 1) + '"' + n + 'title="' + k.limitDesc + '">第' + d + "张 " + k.subType + "通兑券 [" + g(k.endTime) + '到期]</label><span class="coupon-new"></span></li>', c.append(j), 2 == $(".coupon-new").length && $(".coupon-new").eq(0).remove(); var o = c.find("input[name='coupon']").eq(-1); o.prop("checked") || "this" != o.attr("data-session") || (r == b && (i.eq(0).prop("checked", !1), f(i.eq(0))), o.prop("checked", !0), f(o)), $(".tips-add-coupon").addClass("success").html(h.message), a.val(""), setTimeout(function() { $(".tips-add-coupon").removeClass("success").html("") }, 5e3) } else $(".tips-add-coupon").addClass("fail").html(h.error), a.val(""), setTimeout(function() { $(".tips-add-coupon").removeClass("fail").html("") }, 5e3) } }) } }) } } }), $(function() { $("body").on("click", "[gaevent]", function() { var a = this.getAttribute("gaevent").split("|"), b = ["_trackEvent"]; 1 === a.length ? b.push("InnerLink", "Click", a[0]) : b = b.concat(a), _gaq.push(b) }) });